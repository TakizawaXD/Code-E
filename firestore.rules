rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Reglas para los perfiles de usuario
    match /users/{userId} {
      // PERMISOS DE LECTURA:
      // - Cualquier usuario autenticado puede leer perfiles (para la tabla de clasificación).
      // - "read" incluye "get" (leer un doc) y "list" (listar la colección).
      allow read: if request.auth != null;

      // PERMISOS DE ESCRITURA:
      // - Un usuario solo puede crear o actualizar su propio perfil.
      allow write: if request.auth != null && request.auth.uid == userId;
    }

    // Reglas para los cursos
    match /courses/{courseId} {
      allow read: if true; // Cualquiera puede ver los cursos
      
      match /modules/{moduleId} {
        allow read: if true; // Cualquiera puede ver los módulos

        match /lessons/{lessonId} {
          allow read: if true; // Cualquiera puede ver las lecciones

          match /comments/{commentId} {
            allow read: if true; // Cualquiera puede leer comentarios
            allow create: if request.auth != null; // Solo usuarios autenticados pueden crear comentarios
          }
        }
      }
    }

    // Reglas para las rutas de aprendizaje
    match /learningPaths/{pathId} {
        allow read: if true; // Cualquiera puede ver las rutas
    }

    // Reglas para el progreso del usuario
    match /users/{userId}/progress/{courseId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // Reglas para las notificaciones del usuario
    match /users/{userId}/notifications/{notificationId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // Reglas para el foro
    match /forumThreads/{threadId} {
        allow read: if true; // Cualquiera puede leer las discusiones
        allow create: if request.auth != null; // Usuarios autenticados pueden crear discusiones
        allow update: if request.auth != null; // Usuarios autenticados pueden actualizar (para contador de posts, etc)

        match /posts/{postId} {
            allow read: if true; // Cualquiera puede leer respuestas
            allow create: if request.auth != null; // Usuarios autenticados pueden responder
        }
    }
  }
}
