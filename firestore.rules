rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Regla para la colección de usuarios
    match /users/{userId} {
      // CUALQUIERA puede leer (get) y listar (list) los perfiles de usuario.
      // Esto es necesario para la tabla de clasificación y para ver perfiles públicos.
      allow read: if true;

      // SOLO el usuario autenticado y propietario del documento puede escribir en él.
      allow write: if request.auth != null && request.auth.uid == userId;
    }

    // Reglas para rutas de aprendizaje, cursos, módulos y lecciones
    // Se permite la lectura pública para que todos puedan ver el catálogo de cursos.
    match /learningPaths/{pathId} {
      allow read: if true;
      allow write: if false; // Proteger contra escritura desde el cliente
    }

    match /courses/{courseId} {
      allow read: if true;
      allow write: if false; // Proteger contra escritura desde el cliente
    }

    match /courses/{courseId}/modules/{moduleId} {
      allow read: if true;
      allow write: if false; // Proteger contra escritura desde el cliente
    }
    
    match /courses/{courseId}/modules/{moduleId}/lessons/{lessonId} {
      allow read: if true;
      allow write: if false; // Proteger contra escritura desde el cliente
    }

    // Reglas para los comentarios de las lecciones
    match /courses/{courseId}/modules/{moduleId}/lessons/{lessonId}/comments/{commentId} {
      allow read: if true;
      // Solo usuarios autenticados pueden crear comentarios.
      // Permitir que el autor del comentario lo edite/borre en el futuro.
      allow write: if request.auth != null;
    }

    // Reglas para los foros
    match /forumThreads/{threadId} {
      allow read: if true;
      // Solo usuarios autenticados pueden crear hilos.
      // Solo el autor puede actualizar o borrar su propio hilo.
      allow create: if request.auth != null;
      allow update, delete: if request.auth != null && request.resource.data.authorId == request.auth.uid;
    }

    match /forumThreads/{threadId}/posts/{postId} {
        allow read: if true;
        // Solo usuarios autenticados pueden crear respuestas.
        allow create: if request.auth != null;
        allow update, delete: if request.auth != null && request.resource.data.authorId == request.auth.uid;
    }

    // Reglas para las notificaciones del usuario
    match /users/{userId}/notifications/{notificationId} {
        // Un usuario solo puede acceder a sus propias notificaciones
        allow read, write: if request.auth != null && request.auth.uid == userId;
    }
  }
}
